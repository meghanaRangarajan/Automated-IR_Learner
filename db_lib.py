import sqlite3

def create_insert(remote_id,protocol_id,key_id,code):
    conn = sqlite3.connect('codes.db')

    conn.execute('''CREATE TABLE IF NOT EXISTS key_codes
             (REMOTE_ID      INT    NOT NULL,
             P_ID           INT     ,
             KEY_ID         INT,
             CODE           STRING  NOT NULL);''')

    delete = "DELETE from key_codes where KEY_ID=" + str(key_id) +" AND REMOTE_ID=" + str(remote_id) +";"
    conn.execute(delete);
    sql = "INSERT INTO key_codes (REMOTE_ID,P_ID,KEY_ID,CODE) VALUES ("+str(remote_id)+" ,"+str(protocol_id)+" ,"+str(key_id)+" ,'"+str(hex(code))+"')"
    conn.execute(sql);

    conn.commit()
    #check if the key is already present
    if conn.total_changes == 1:
        conn.close()
        return 1
    else:
        conn.close()
        return 0


def show_key_codes():
     conn = sqlite3.connect('codes.db')
     print ("Opened database successfully");
     cursor = conn.execute("SELECT REMOTE_ID,P_ID,KEY_ID,CODE from key_codes")
     for row in cursor:
         print ("R_ID = ", row[0])
         print ("P_ID = ", row[1])
         print ("K_ID = ", row[2])
         print ("CODE = ", row[3], "\n")
     return

    
def remote_id_return():
    conn = sqlite3.connect('codes.db')
    cursor = conn.execute("SELECT REMOTE_ID from remotes")
    r_id = list()
    for row in cursor:
        r_id.append(row[0])

    size = len(r_id)
    if(size == 0):
        return 1
    if(size == 1):
        return 1
    for i in range(size):
        for j in range (i+1,size):
            if r_id[i]>r_id[j]:
                temp = r_id[i]
                r_id[i] = r_id[j]
                r_id[j] = temp

    remote_id = r_id[size-1]
    print("Remote ID is ",remote_id)
    return remote_id

def online_remote_check(remote_id,key_id):
    conn = sqlite3.connect('tv.db')
    select = "SELECT remote_id,key,code from key_codes where remote_id=" +str(remote_id) +"; "
    cursor = conn.execute(select)
    maps = list()
    for row in cursor:
         maps.append((row[1],row[2]))
    for i in range (len(maps)):
        key = maps[i][0]
        codex = maps[i][1]
        code = int(codex,16)
        if(key == key_id):
            return code
         

def count_return(remote_id):
    conn = sqlite3.connect('tv.db')
    select = "SELECT remote_id,key,code from key_codes where remote_id=" +str(remote_id) +"; "
    cursor = conn.execute(select)
    maps = list()
    for row in cursor:
         maps.append((row[1],row[2]))
    size = len(maps)
    return size

def key_map(remote_id):
    conn = sqlite3.connect('tv.db')
    select = "SELECT remote_id,key,code from key_codes where remote_id=" +str(remote_id) +"; "
    cursor = conn.execute(select)
    keys = list()
    for row in cursor:
         keys.append(row[1])
    return keys

def code_map(remote_id):#codes are strings 
    conn = sqlite3.connect('tv.db')
    select = "SELECT remote_id,key,code from key_codes where remote_id=" +str(remote_id) +"; "
    cursor = conn.execute(select)
    codes = list()
    for row in cursor:
         codes.append(row[2])
    return codes

def auto_complete(remote_id,online_remote_id,protocol_id):
    conn = sqlite3.connect('tv.db')
    select = "SELECT remote_id,key,code from key_codes where remote_id=" +str(online_remote_id) +"; "
    cursor = conn.execute(select)
    maps = list()
    for row in cursor:
         maps.append((row[1],row[2]))
    for i in range(0,len(maps)):
        key = maps[i][0]
        codex = maps[i][1]
        code = int(codex,16)
        print(key,"    ",str(hex(code)))
        create_insert(remote_id,protocol_id,key,code)  
    return

def get_remote_name(remote_id):
    conn = sqlite3.connect('codes.db')
    print ("Opened database successfully");
    cursor = conn.execute("SELECT REMOTE_ID,REMOTE_NAME from remotes")
    for row in cursor:
         r_id = row[0]
         name = row[1]
         if r_id == remote_id:
             return name

def remote_db(remote_id,remote_name,protocol_id,length,toggle_present,toggle_mask):
    conn = sqlite3.connect('codes.db')
    if conn!=None:
            print ("Opened database successfully");
    create = "CREATE TABLE IF NOT EXISTS remotes (REMOTE_ID INT NOT NULL, REMOTE_NAME STRING NOT NULL, P_ID INT,LENGTH INT NOT NULL,GAP INT NOT NULL ,TOGGLE INT ,TOGGLE_MASK STRING NOT NULL, EXISTING_REMOTE INT, EXISTING_R_ID INT);"

    conn.execute(create)

    delete = "DELETE from remotes where REMOTE_ID=" + str(remote_id) +";"
    conn.execute(delete);
    sql = "INSERT INTO remotes (REMOTE_ID,REMOTE_NAME, P_ID,LENGTH, GAP,TOGGLE,TOGGLE_MASK,EXISTING_REMOTE,EXISTING_R_ID) VALUES ("+str(remote_id)+" ,'"+str(remote_name)+"',"+str(protocol_id)+" ,"+str(length)+","+str(400)+","+str(toggle_present)+" ,'"+str(hex(toggle_mask))+"',"+str(0)+" ,"+str(0)+")"
    conn.execute(sql);
    conn.commit()
    return
             
def show_remotes():
     conn = sqlite3.connect('codes.db')
     print ("Opened database successfully");
     cursor = conn.execute("SELECT REMOTE_ID,REMOTE_NAME, P_ID, TOGGLE,TOGGLE_MASK,EXISTING_REMOTE,EXISTING_R_ID from remotes ")
     for row in cursor:
         print ("R_ID = ", row[0])
         print ("REMOTE NAME = ", row[1])
         print ("P_ID = ", row[2])
         print ("TOGGLE_PRESENT = ", row[3])
         print ("TOGGLE_MASK = ", row[4])
         print ("EXISTING REMOTE = ", row[5])
         print ("EXISTING R_ID = ", row[6], "\n")
     return

def existing_remote_update(remote_id,online_remote_id):
    conn = sqlite3.connect('codes.db')
    print ("Opened database successfully for\n\n");
    cursor = conn.execute("SELECT REMOTE_ID,REMOTE_NAME, P_ID, LENGTH,GAP,TOGGLE,TOGGLE_MASK,EXISTING_REMOTE,EXISTING_R_ID from remotes where REMOTE_ID = "+str(remote_id))
    for row in cursor:
        remote_name = row[1]
        protocol_id = row[2]
        length = row[3]
        toggle_present = row[5]
        toggle_mask = int(row[6],16)

    delete = "DELETE from remotes where REMOTE_ID=" + str(remote_id) +";"
    conn.execute(delete);
    sql = "INSERT INTO remotes (REMOTE_ID,REMOTE_NAME, P_ID,LENGTH, GAP,TOGGLE,TOGGLE_MASK,EXISTING_REMOTE,EXISTING_R_ID) VALUES ("+str(remote_id)+" ,'"+str(remote_name)+"',"+str(protocol_id)+" ,"+str(length)+" ,"+str(400)+" ,"+str(toggle_present)+" ,'"+str(hex(toggle_mask))+"',"+str(1)+" ,"+str(online_remote_id)+")"

    conn.execute(sql);
    conn.commit()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
    return

    
def delete_key(remote_id,key):
    conn = sqlite3.connect('codes.db')
    if conn!=None:
            print ("Opened database successfully");

    conn.execute('''CREATE TABLE IF NOT EXISTS key_codes
             (REMOTE_ID      INT    NOT NULL,
             P_ID           INT     ,
             KEY_ID         INT,
             CODE           STRING  NOT NULL);''')


    delete = "DELETE from key_codes where KEY_ID=" + str(key) +" AND REMOTE_ID=" + str(remote_id) +";"
    conn.execute(delete);
    conn.commit()

    print(conn.total_changes)

    print("deleted")
    return

def update_new_remote(remote_id,online_remote_id,protocol_id):
    conn = sqlite3.connect('tv.db')
    select = "SELECT remote_id,key,code from key_codes where remote_id=" +str(online_remote_id) +"; "
    cursor = conn.execute(select)
    maps = list()
    for row in cursor:
         maps.append((row[1],row[2]))
    for i in range(0,len(maps)):
        key = maps[i][0]
        codex = maps[i][1]
        code = int(codex,16)
        print(key,"    ",str(hex(code)))
        create_insert(remote_id,protocol_id,key,code)

    return


#remote_db(1,'airtel',0,0,0,0)
"""#show_remotes()
existing_remote_update(2,19)
show_remotes()
name = get_remote_name(2)
print(name)
print(remote_id_return())
r = get_final_db_rid()
print(r)

remote_db(1,0,0,0)
remote_db(2,3,1,32768)
show_remotes()

delete_key(3,6)

remote_name_db(1,"airtel")
remote_name_db(2,"sky")
remote_name_db(3,"atta")
remote_name_db(3,"tata")
show_remote_names()

name = get_remote_name(17)
print(name)

auto_complete(3,9,3)

c = online_remote_check(9,10)
print(c)
size = count_return(9)
print(size)

keys = list()
keys = key_map(9)
print(keys)

codes = list()
codes = code_map(9)
print(codes)"""

